<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciar Site - Edson Maltez</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    /* Estilo para melhorar a aparência */
    .css-1dbjc4n {
      background-color: #0a2472;
    }
    .video-preview {
      border: 2px dashed #c9a227;
      padding: 20px;
      border-radius: 12px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // Configurar pasta de mídia para vídeos
    CMS.init({
      config: {
        media_folder: "public/images/uploads",
        public_folder: "/images/uploads",
        media_folder_video: "public/videos/uploads",
        public_folder_video: "/videos/uploads"
      }
    });

    // Função para extrair ID do YouTube
    function extractYouTubeId(url) {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    // Widget personalizado para vídeo de destaque
    CMS.registerEditorComponent({
      id: "featured-video",
      label: "Vídeo",
      icon: "video",
      fields: [
        {
          name: "type",
          label: "Tipo de vídeo",
          widget: "select",
          options: [
            { label: "Upload MP4", value: "upload" },
            { label: "YouTube", value: "youtube" }
          ],
          default: "upload"
        },
        {
          name: "file",
          label: "Arquivo de vídeo",
          widget: "file",
          required: false,
          media_library: {
            config: {
              multiple: false,
              max_file_size: 52428800 // 50MB
            }
          },
          pattern: "{{type}}",
          condition: "type === 'upload'"
        },
        {
          name: "url",
          label: "URL do YouTube",
          widget: "string",
          required: false,
          hint: "Cole o link do vídeo (ex: https://youtu.be/... ou https://youtube.com/watch?v=...)",
          condition: "type === 'youtube'"
        },
        {
          name: "caption",
          label: "Legenda (opcional)",
          widget: "string",
          required: false
        }
      ],
      pattern: /^{{video (.*?)}}$/,
      fromBlock: function(match) {
        return {
          type: "upload",
          file: match[1]
        };
      },
      toBlock: function(obj) {
        if (obj.type === 'youtube' && obj.url) {
          return `{{video youtube="${obj.url}" caption="${obj.caption || ''}"}}`;
        } else if (obj.file) {
          return `{{video file="${obj.file}" caption="${obj.caption || ''}"}}`;
        }
        return '';
      },
      toPreview: function(obj) {
        let videoHtml = '';
        
        if (obj.type === 'youtube' && obj.url) {
          const videoId = extractYouTubeId(obj.url);
          if (videoId) {
            videoHtml = `
              <div style="position: relative; padding-bottom: 56.25%; height: 0; margin: 20px 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <iframe src="https://www.youtube.com/embed/${videoId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>
              </div>
            `;
          } else {
            videoHtml = `<p style="color: red;">URL do YouTube inválida</p>`;
          }
        } else if (obj.file) {
          videoHtml = `
            <video controls style="width: 100%; max-height: 500px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <source src="${obj.file}" type="video/mp4">
              Seu navegador não suporta vídeos.
            </video>
          `;
        }

        if (obj.caption) {
          videoHtml += `<p style="text-align: center; margin-top: 8px; font-size: 14px; color: #666;">${obj.caption}</p>`;
        }

        return videoHtml || '<p>Configure o vídeo</p>';
      }
    });

    // Registrar componente para o corpo do artigo
    CMS.registerEditorComponent({
      id: "inline-video",
      label: "Inserir Vídeo",
      icon: "video",
      fields: [
        {
          name: "type",
          label: "Tipo de vídeo",
          widget: "select",
          options: [
            { label: "Upload MP4", value: "upload" },
            { label: "YouTube", value: "youtube" }
          ],
          default: "upload"
        },
        {
          name: "file",
          label: "Arquivo de vídeo",
          widget: "file",
          required: false,
          media_library: {
            config: {
              multiple: false,
              max_file_size: 52428800
            }
          },
          condition: "type === 'upload'"
        },
        {
          name: "url",
          label: "URL do YouTube",
          widget: "string",
          required: false,
          condition: "type === 'youtube'"
        }
      ],
      pattern: /^{{inline-video (.*?)}}$/,
      fromBlock: function(match) {
        return {};
      },
      toBlock: function(obj) {
        if (obj.type === 'youtube' && obj.url) {
          return `<div class="video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; margin: 20px 0;">
            <iframe src="https://www.youtube.com/embed/${extractYouTubeId(obj.url)}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>
          </div>`;
        } else if (obj.file) {
          return `<video controls style="width: 100%; max-height: 500px; border-radius: 12px; margin: 20px 0;">
            <source src="${obj.file}" type="video/mp4">
          </video>`;
        }
        return '';
      },
      toPreview: function(obj) {
        if (obj.type === 'youtube' && obj.url) {
          const videoId = extractYouTubeId(obj.url);
          if (videoId) {
            return `<div style="position: relative; padding-bottom: 56.25%; height: 0; margin: 20px 0;">
              <iframe src="https://www.youtube.com/embed/${videoId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>
            </div>`;
          }
        } else if (obj.file) {
          return `<video controls style="width: 100%; max-height: 500px;">
            <source src="${obj.file}" type="video/mp4">
          </video>`;
        }
        return '<p>Configure o vídeo</p>';
      }
    });

    console.log('Widgets de vídeo registrados com sucesso!');
  </script>
</body>
</html>